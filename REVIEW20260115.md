# Code Review: sysm Swift CLI

**Date:** 2026-01-15
**Reviewer:** Code Review Analysis
**Repository:** `/Users/bss/code/sysm`
**Version:** 1.0.0

---

## Executive Summary

sysm is a well-structured Swift CLI tool providing scriptable access to macOS apps and services. The codebase demonstrates solid Swift fundamentals with good use of modern patterns like actors for thread safety and proper ArgumentParser integration. However, there are several security vulnerabilities, code duplication issues, and architectural improvements that should be addressed.

**Overall Assessment:** Good foundation with room for improvement in security hardening and DRY compliance.

---

## Table of Contents

1. [Code Quality & Style](#1-code-quality--style)
2. [Architecture](#2-architecture)
3. [Error Handling](#3-error-handling)
4. [Security](#4-security)
5. [Performance](#5-performance)
6. [Testing & Maintainability](#6-testing--maintainability)
7. [Missing Features / Improvements](#7-missing-features--improvements)

---

## 1. Code Quality & Style

### Strengths

- **Modern Swift Patterns:** Good use of `actor` for services requiring thread safety (`CalendarService`, `ReminderService`, `ContactsService`, `PhotosService`)
- **Clean Command Structure:** Consistent use of ArgumentParser with proper subcommand organization
- **Type Safety:** Strong typing throughout with `Codable` models and proper error enums
- **Consistent Naming:** CamelCase for types, lowerCamelCase for properties and methods

### Issues

#### HIGH: Inconsistent Async/Sync Pattern
**Files:** `Sources/sysm/Commands/**/*.swift`

Some commands use `AsyncParsableCommand` while others use `ParsableCommand`, creating an inconsistent API surface.

```swift
// CalendarAdd.swift - Uses async
struct CalendarAdd: AsyncParsableCommand { ... }

// MessagesSend.swift - Uses sync
struct MessagesSend: ParsableCommand { ... }
```

**Recommendation:** Standardize on `AsyncParsableCommand` for all commands that interact with services, especially those that may need EventKit access which is inherently async.

#### MEDIUM: Force Unwrapping in Multiple Locations
**Files:** Various command files

```swift
// CalendarAdd.swift:47-49
} else if allDay {
    endDate = cal.date(byAdding: .day, value: 1, to: cal.startOfDay(for: startDate))!
} else {
    endDate = cal.date(byAdding: .hour, value: 1, to: startDate)!
}
```

**Recommendation:** Use guard statements or provide meaningful errors instead of force unwrapping.

#### LOW: Missing Access Control Modifiers
**Files:** Most service files

Services expose internal types that should be `private` or `fileprivate`.

```swift
// WorkflowEngine.swift - ExecutionContext should likely be private
struct ExecutionContext { ... }
```

---

## 2. Architecture

### Strengths

- **Clear Separation of Concerns:** Services handle business logic, Commands handle CLI interface
- **Phased Design:** Well-organized into logical phases (Core PIM, Extended Apps, System Integration, Automation)
- **Codable Models:** Clean data transfer between services and commands
- **Entry Point:** Clean `@main` struct with well-organized subcommand registration

### Issues

#### HIGH: Service Instantiation Anti-Pattern
**Files:** All command files

Services are instantiated locally in each command's `run()` method:

```swift
// CalendarAdd.swift:52
let service = CalendarService()

// MessagesSend.swift:17
let service = MessagesService()
```

**Problems:**
1. No dependency injection - makes testing difficult
2. No service lifecycle management
3. Cannot share state between commands
4. EventStore instances are recreated unnecessarily

**Recommendation:** Implement a service container or dependency injection pattern:

```swift
protocol ServiceContainer {
    var calendar: CalendarService { get }
    var reminders: ReminderService { get }
    // ...
}
```

#### MEDIUM: Mixed Concerns in Models
**File:** `/Users/bss/code/sysm/Sources/sysm/Models/TrackedReminder.swift`

`TrackedReminder.swift` contains multiple unrelated types:
- `TrackedReminder`
- `SysmCache`
- `AnyCodable`

**Recommendation:** Split into separate files: `TrackedReminder.swift`, `SysmCache.swift`, `AnyCodable.swift`

#### MEDIUM: TriggerService Hardcoded Path
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/TriggerService.swift:7-8`

```swift
self.triggerPath = FileManager.default.homeDirectoryForCurrentUser
    .appendingPathComponent("dayai/_dayai/TRIGGER.md")
```

Hardcoded to a specific project path, making this feature unusable for others.

**Recommendation:** Make configurable via environment variable or config file.

#### LOW: Missing Protocol Abstractions
Services lack protocol definitions, preventing easy mocking for tests.

**Recommendation:** Define protocols for each service:
```swift
protocol CalendarServiceProtocol {
    func getTodayEvents() async throws -> [CalendarEvent]
    // ...
}
```

---

## 3. Error Handling

### Strengths

- **Custom Error Types:** Each service has its own `LocalizedError` enum with descriptive messages
- **User-Friendly Messages:** Error descriptions provide actionable guidance (e.g., "Grant permission in System Settings")
- **Proper Error Propagation:** Errors bubble up correctly through the command chain

### Issues

#### HIGH: Silent Error Swallowing
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/PluginManager.swift:99-101`

```swift
if let plugin = try? loadPlugin(path: pluginPath) {
    plugins.append(plugin)
}
// Invalid plugins are silently skipped
```

Also in `/Users/bss/code/sysm/Sources/sysm/Services/WorkflowEngine.swift:591-596`:

```swift
} catch {
    // Skip invalid workflow files
    continue
}
```

**Recommendation:** Log warnings or provide a verbose mode to surface these issues.

#### MEDIUM: Inconsistent Error Handling in Commands
**File:** `/Users/bss/code/sysm/Sources/sysm/Commands/Reminders/RemindersAdd.swift:37-39`

```swift
} catch ReminderError.invalidYear(let year) {
    fputs("Error: Year \(year) out of valid range (2000-2100)\n", stderr)
    throw ExitCode.failure
}
```

This catches only one specific error type. Other errors will produce less user-friendly output.

**Recommendation:** Standardize error handling across all commands, possibly with a shared error formatting utility.

#### LOW: Missing Timeout Error Context
**File:** `/Users/bss/code/sysm/Services/PluginManager.swift:356-358`

```swift
if timedOut {
    throw PluginError.executionFailed("Timeout after \(Int(timeout)) seconds")
}
```

Doesn't include which plugin/command timed out.

---

## 4. Security

### CRITICAL: AppleScript Injection Vulnerabilities

Multiple services construct AppleScript strings with user input without proper escaping.

#### CRITICAL: NotesService - ID Injection
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/NotesService.swift:57-61`

```swift
func getNote(id: String) throws -> Note? {
    let script = """
    tell application "Notes"
        try
            set n to note id "\(id)"  // INJECTION POINT
```

**Attack Vector:** A malicious note ID like `"} & do shell script "malicious command" & {"` could execute arbitrary shell commands.

#### CRITICAL: NotesService - Folder Name Injection
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/NotesService.swift:22-23`

```swift
let folderFilter = folder.map { "folder \"\($0)\"" } ?? "default folder"
```

No escaping of folder name input.

#### HIGH: MusicService - Search Query Injection
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/MusicService.swift:195-199`

```swift
func searchLibrary(query: String, limit: Int = 20) throws -> [Track] {
    let escapedQuery = query.replacingOccurrences(of: "\"", with: "\\\"")
    let script = """
    tell application "Music"
        set results to search library playlist 1 for "\(escapedQuery)"
```

Only escapes double quotes - other characters like backslashes could break out.

**Recommendation:** Implement comprehensive AppleScript escaping:

```swift
extension String {
    var appleScriptEscaped: String {
        self.replacingOccurrences(of: "\\", with: "\\\\")
            .replacingOccurrences(of: "\"", with: "\\\"")
            .replacingOccurrences(of: "\n", with: "\\n")
            .replacingOccurrences(of: "\r", with: "\\r")
    }
}
```

#### HIGH: TagsService - mdfind Query Injection
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/TagsService.swift:111-112`

```swift
func findByTag(name: String, scope: String? = nil) throws -> [String] {
    var args = ["kMDItemUserTags == '\(name)'"]  // Single quote injection possible
```

**Attack Vector:** Tag name containing `'` could break out of the query.

#### HIGH: SpotlightService - Query Injection
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/SpotlightService.swift:84`

```swift
args.append("kMDItemKind == '\(kindValue)'")
```

Same single-quote injection issue.

#### MEDIUM: LaunchdService - Command Injection via Plist
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/LaunchdService.swift:309-310`

```swift
<string>/bin/bash</string>
<string>-c</string>
<string>\(escapeXml(command))</string>
```

While XML escaping is done, the command itself runs through bash -c which could still be exploited with carefully crafted input.

**Recommendation:** Validate commands don't contain shell metacharacters or use a safer execution model.

#### MEDIUM: Plugin System - Arbitrary Code Execution
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/PluginManager.swift:327-329`

```swift
let task = Process()
task.executableURL = URL(fileURLWithPath: "/bin/bash")
task.arguments = [scriptPath]
```

Plugins execute arbitrary bash scripts. This is by design but should:
1. Warn users about plugin sources
2. Consider sandboxing options
3. Validate plugin manifest integrity

### Input Validation Issues

#### MEDIUM: Insufficient Path Validation
**File:** `/Users/bss/code/sysm/Sources/sysm/Commands/Exec/ExecRun.swift:90-91`

```swift
let expandedPath = (scriptPath as NSString).expandingTildeInPath
result = try runner.runFile(path: expandedPath, ...)
```

No validation that the path doesn't traverse outside expected directories (e.g., `../../etc/passwd`).

#### LOW: Missing Email/Phone Validation
**File:** `/Users/bss/code/sysm/Sources/sysm/Commands/Messages/MessagesSend.swift`

The recipient argument accepts any string without validating it's a valid phone number or email.

---

## 5. Performance

### Strengths

- **EventKit Native APIs:** Calendar and Reminders use EventKit directly instead of AppleScript
- **Timeout Handling:** Script execution has configurable timeouts

### Issues

#### MEDIUM: N+1 Query Pattern in NotesService
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/NotesService.swift:90-101`

```swift
func getNotes(from folder: String) throws -> [Note] {
    let notesList = try listNotes(folder: folder)
    var notes: [Note] = []
    for noteInfo in notesList {
        if let note = try getNote(id: noteInfo.id) {  // AppleScript call per note!
            notes.append(note)
        }
    }
    return notes
}
```

Each note requires a separate AppleScript execution. For large folders, this will be extremely slow.

**Recommendation:** Rewrite to fetch all note data in a single AppleScript call.

#### MEDIUM: Regex Compilation in Hot Paths
**File:** `/Users/bss/code/sysm/Sources/sysm/Models/Note.swift:56-98`

```swift
for (pattern, replacement) in replacements {
    if let regex = try? NSRegularExpression(pattern: pattern, options: .caseInsensitive) {
        text = regex.stringByReplacingMatches(...)
    }
}
```

Regex objects are compiled on every call to `htmlToMarkdown`. Should be cached as static constants.

#### LOW: Unnecessary Full Calendar Scan
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/CalendarService.swift:126-135`

```swift
func deleteEvent(title: String) async throws -> Bool {
    // Searches 30 days back to 365 days forward for every delete
    let startDate = cal.date(byAdding: .day, value: -30, to: Date())!
    let endDate = cal.date(byAdding: .day, value: 365, to: Date())!
```

Should accept event ID for direct deletion instead of searching by title.

#### LOW: DateParser Regex Compilation
**File:** `/Users/bss/code/sysm/Sources/sysm/Services/DateParser.swift:83-85`

```swift
if let regex = try? NSRegularExpression(pattern: pattern, options: .caseInsensitive),
```

Regex compiled on every parse call.

---

## 6. Testing & Maintainability

### Issues

#### CRITICAL: No Test Coverage

**File:** `/Users/bss/code/sysm/Package.swift`

```swift
targets: [
    .executableTarget(
        name: "sysm",
        ...
    ),
    // No test targets defined
]
```

The project has zero test targets.

**Recommendation:** Add test targets:
```swift
.testTarget(
    name: "sysmTests",
    dependencies: ["sysm"],
    path: "Tests/sysmTests"
),
```

#### HIGH: Services Not Mockable

Without protocols, services cannot be mocked for testing commands in isolation.

#### MEDIUM: Missing Documentation

No documentation comments on public APIs. Consider adding DocC documentation:

```swift
/// Manages calendar events using EventKit.
///
/// This service provides access to the user's calendars and events.
/// Access must be granted before use via ``ensureAccess()``.
actor CalendarService {
    /// Fetches events for the current day.
    /// - Returns: Array of calendar events occurring today.
    /// - Throws: `CalendarError.accessDenied` if permission not granted.
    func getTodayEvents() async throws -> [CalendarEvent]
}
```

#### LOW: Magic Numbers
**Files:** Various

```swift
// CalendarService.swift:109-110
if year < 2000 || year > 2100 {

// ScriptRunner.swift:107,144
timeout: TimeInterval = 300
```

Should be named constants.

---

## 7. Missing Features / Improvements

### Should Have

1. **Configuration System**
   - No `~/.sysm/config.yaml` for default settings
   - Hardcoded values like default reminder list name ("Reminders")

2. **Logging Framework**
   - No structured logging
   - Debug mode for troubleshooting

3. **Shell Completions**
   - ArgumentParser supports generating completions but not exposed

4. **Better Date/Time Handling**
   - `DateParser` is incomplete (no "in 2 hours", "next week", etc.)

### Nice to Have

1. **Interactive Mode**
   - No REPL for exploratory use

2. **Output Formatters**
   - Only JSON and text; consider adding CSV, plist, markdown table

3. **Undo/History**
   - No way to undo operations or view history

4. **Batch Operations**
   - Cannot add multiple reminders/events in one command

### Over-Engineered Areas

1. **AnyCodable Implementation**
   **File:** `/Users/bss/code/sysm/Sources/sysm/Models/TrackedReminder.swift:69-114`

   Custom `AnyCodable` type is complex. Consider using a library like [AnyCodable](https://github.com/Flight-School/AnyCodable) or simplifying the cache structure.

2. **WorkflowEngine Template Filters**
   **File:** `/Users/bss/code/sysm/Sources/sysm/Services/WorkflowEngine.swift:504-537`

   Implemented filters (upper, lower, trim, first, last, json, length) that may rarely be used. Consider YAGNI principle.

---

## Code Duplication Analysis

### HIGH: AppleScript Runner Pattern
Duplicated across 5+ services:

```swift
// Pattern repeated in NotesService, MailService, MessagesService,
// MusicService, FocusService, SafariService, ShortcutsService

private func runAppleScript(_ script: String) throws -> String {
    let tempFile = FileManager.default.temporaryDirectory.appendingPathComponent("sysm-XXX-\(UUID().uuidString).scpt")
    try script.write(to: tempFile, atomically: true, encoding: .utf8)
    defer { try? FileManager.default.removeItem(at: tempFile) }

    let task = Process()
    task.executableURL = URL(fileURLWithPath: "/usr/bin/osascript")
    task.arguments = [tempFile.path]
    // ... identical boilerplate
}
```

**Recommendation:** Extract to shared utility:

```swift
struct AppleScriptRunner {
    static func run(_ script: String, identifier: String = "generic") throws -> String
}
```

### MEDIUM: JSON Output Pattern
Repeated in ~15+ commands:

```swift
if json {
    let encoder = JSONEncoder()
    encoder.outputFormatting = [.prettyPrinted, .sortedKeys]
    let data = try encoder.encode(result)
    print(String(data: data, encoding: .utf8)!)
}
```

**Recommendation:** Create output utility:

```swift
struct OutputFormatter {
    static func print<T: Encodable>(_ value: T, asJSON: Bool) throws
}
```

### MEDIUM: Process Execution Pattern
Duplicated in TagsService, SpotlightService, LaunchdService, FocusService:

```swift
let task = Process()
task.executableURL = URL(fileURLWithPath: "/path/to/executable")
task.arguments = [...]

let outputPipe = Pipe()
let errorPipe = Pipe()
task.standardOutput = outputPipe
task.standardError = errorPipe

try task.run()
task.waitUntilExit()
// ... read output
```

### LOW: Date Formatting
Multiple inline DateFormatter creations with same formats.

---

## Priority Summary

| Severity | Count | Categories |
|----------|-------|------------|
| CRITICAL | 3 | AppleScript injection (2), No tests (1) |
| HIGH | 7 | Command injection, async inconsistency, service patterns |
| MEDIUM | 12 | Validation, performance, duplication |
| LOW | 8 | Style, documentation, magic numbers |

---

## Recommended Next Steps

1. **Immediate (Security):**
   - Implement AppleScript string escaping utility
   - Add input validation for all user-provided strings passed to scripts
   - Review and sandbox plugin execution

2. **Short-term (Quality):**
   - Add test target and initial test coverage for core services
   - Extract duplicated code (AppleScript runner, JSON output, Process execution)
   - Define service protocols for mockability

3. **Medium-term (Architecture):**
   - Implement dependency injection container
   - Add configuration system
   - Standardize on async/await throughout

4. **Long-term (Features):**
   - Add shell completions
   - Improve DateParser with more natural language support
   - Add logging framework with debug mode

---

*End of Review*
